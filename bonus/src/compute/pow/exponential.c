/*
** EPITECH PROJECT, 2021
** bistromatic
** File description:
** exponential
*/

#include "bistromatic.h"
#include <stdlib.h>
#define EXP "2.7182818284590452353602874713526624977572470936999595749669676277240766303535475945713821785251664274274663919320030599218174135"

char *my_pow(char *nb, char *pwr, char *base, char *ops)
{
    char *result = char_to_str(base[1]);
    char *fir_char = char_to_str(base[1]);
    int neg = (pwr[0] == '-') ? (1) : (0);

    pwr = my_strdup(pwr);
    if (neg)
        re_alloc(&pwr, my_strdup(pwr + 1), 1);
    while (pwr[0] != 0 && pwr[0] != '0' && my_strcmp(pwr, "-0") != 0) {
        if (result[0] == base[0] && my_strlen(result) == 1)
            break;
        re_alloc(&result, infin_mul(result, nb, base, ops), 1);
        re_alloc(&pwr, infin_sub(pwr, "1", BASE, OPS), 1);
    }
    if (neg)
        re_alloc(&result, infin_div(fir_char, result, base, ops), 1);
    free(fir_char);
    free(pwr);
    return result;
}

char *exp_decimal(char *decimal)
{
    if (my_strstr(decimal, "0") == 0)
        return my_strdup("1");
    char *constants[41] = 
   {"1.6487212707001281468486507878141635716537761007101480115750793116406610211942156086327765200563666430028666377563077970046711669",
    "1.6487212707001281468486507878141635716537761007101480115750793116406610211942156086327765200563666430028666377563077970046711669",
"0.82436063535006407342432539390708178582688805035507400578753965582033051059710780431638826002818332150143331887815389850233558345",
"0.2747868784500213578081084646356939286089626834516913352625132186067768368657026014387960866760611071671444396260512995007785278166",
"0.0686967196125053394520271161589234821522406708629228338156283046516942092164256503596990216690152767917861099065128248751946319541",
"0.0137393439225010678904054232317846964304481341725845667631256609303388418432851300719398043338030553583572219813025649750389263908",
"0.0022898906537501779817342372052974494050746890287640944605209434883898069738808550119899673889671758930595369968837608291731543984",
"0.0003271272362500254259620338864710642007249555755377277800744204983414009962686935731414239127095965561513624281262515470247363426",
"0.0000408909045312531782452542358088830250906194469422159725093025622926751245335866966426779890886995695189203035157814433780920428",
"0.0000045434338368059086939171373120981138989577163269128858343669513658527916148429662936308876765221743909911448350868270420102269",
"0.0000004543433836805908693917137312098113898957716326912885834366951365852791614842966293630887676522174390991144835086827042010226",
"0.0000000413039439709628063083376119281646718087065120628444166760631942350253783167542390330080697865652217362831348644257003819111",
"0.0000000034419953309135671923614676606803893173922093385703680563385995195854481930628532527506724822137684780235945720354750318259",
"0.0000000002647688716087359378739590508215684090301699491207975427952768861219575533125271732885132678625975752325841978488826947558",
"0.0000000000189120622577668527052827893443977435021549963657712530568054918658541109508947980920366619901855410880417284177773353397",
"0.0000000000012608041505177901803521859562931829001436664243847502037870327910569407300596532061357774660123694058694485611851556893",
"0.0000000000000788002594073618862720116222683239312589791515240468877366895494410587956287283253834860916257730878668405350740722305",
"0.0000000000000046353093769036403689418601334308194858223030308262875139229146730034585663957838460874171544572404627553255925924841",
"0.0000000000000002575171876057577982745477851906010825456835017125715285512730373890810314664324358937453974698466923752958662551380",
"0.0000000000000000135535361897767262249761992205579517129307106164511330816459493362674227087596018891444946036761417039629403292177",
"0.0000000000000000006776768094888363112488099610278975856465355308225566540822974668133711354379800944572247301838070851981470164608",
"0.0000000000000000000322703242613731576785147600489475040784064538486931740039189269911129112113323854503440347706574802475308103076",
"0.0000000000000000000014668329209715071672052163658612501853821115385769624547235875905051323277878357022883652168480672839786731958",
"0.0000000000000000000000637753443900655290089224506896195732774831103729114110749385908915274925125145957516680529064377079990727476",
"0.0000000000000000000000026573060162527303753717687787341488865617962655379754614557746204803121880214414896528355377682378332946978",
"0.0000000000000000000000001062922406501092150148707511493659554624718506215190184582309848192124875208576595861134215107295133317879",
"0.0000000000000000000000000040881631019272775005719519672833059793258404085199622483934994161235572123406792148505162119511351281456",
"0.0000000000000000000000000001514134482195287963174797024919742955305866817970356388293888672638354523089140449944635634055975973387",
"0.0000000000000000000000000000054076231506974570113385608032847962689495243498941299581924595451369804396040730355165558359141999049",
"0.0000000000000000000000000000001864697638171536900461572690787860782396387706860044813169813636254131186070370012247088219280758587",
"0.0000000000000000000000000000000062156587939051230015385756359595359413212923562001493772327121208471039535679000408236273976025286",
"0.0000000000000000000000000000000002005051223840362258560830850309527723006868502000048186204100684144227081796096787362460450839525",
"0.0000000000000000000000000000000000062657850745011320580025964072172741343964640687501505818878146379507096306128024605076889088735",
"0.0000000000000000000000000000000000001898722749848827896364423153702204283150443657197015327844792314530518069882667412275057245113",
"0.0000000000000000000000000000000000000055844786760259644010718328050064831857365989917559274348376244545015237349490218008089918973",
"0.0000000000000000000000000000000000000001595565336007418400306237944287566624496171140501693552810749844143292495699720514516854827",
"0.0000000000000000000000000000000000000000044321259333539400008506609563543517347115865013935932022520829003980347102770014292134856",
"0.0000000000000000000000000000000000000000001197871873879443243473151609825500468840969324700971135743806189296766137912703088976617",
"0.0000000000000000000000000000000000000000000031522944049459032722977673942776328127393929597393977256415952349914898366123765499384",
"0.0000000000000000000000000000000000000000000000808280616652795710845581383148110977625485374292153262985024419228587137592917064086", 0};
    char *result = my_strdup("0");
    int neg = 0;
    if (decimal[0] == '-') {
        neg = 1;
        decimal++;
    }
    char *minus_half = infin_sub(decimal, "0.5", BASE, OPS);    
    if (minus_half[0] == '-' && minus_half[1] == '.') {
        re_alloc(&minus_half, replace(minus_half, 1, 0, "0"), 1);
    }
    char *tmp_pow = 0;
    char *tmp_mul = 0;
    char *i_str = 0;

    for (int i = 0; constants[i]; i++) {
        int_to_str(i, &i_str);
        re_alloc(&tmp_pow, my_pow(minus_half, my_strdup(i_str), BASE, OPS), 0);
        re_alloc(&tmp_mul, infin_mul(constants[i], tmp_pow, BASE, OPS), 0);
        re_alloc(&result, infin_add(result, tmp_mul, BASE, OPS), 1);
        free(i_str);
    }
    free(tmp_mul);
    free(tmp_pow);
    if (neg)
        re_alloc(&result, infin_div(my_strdup("1"), result, BASE, OPS), 1);
    return result;
}

char *my_exp(char *x, char *base, char *ops)
{
    int index_dot = index_of(ops[8], x);
    char *whole_part = my_strdup(x);
    char *decimal_part = my_strdup("0");
    char *e_whole = my_strdup("1");
    char *e_decimal = "1";

    if (index_dot >= 0) {
        whole_part[index_dot] = 0;
        free(decimal_part);
        decimal_part = my_strdup(x + index_dot);
        insert_at_beg(&decimal_part, '0', 1, 1);
        if (x[0] == '-')
            insert_at_beg(&decimal_part, '-', 1, 1);
    }
    e_whole = my_pow(EXP, whole_part, BASE, OPS);
    e_decimal = exp_decimal(decimal_part);

    return infin_mul(e_whole, e_decimal, BASE, OPS);
}

char *new_ln(char *x);

char *infin_pow(char *a, char *b, char *base, char *ops)
{
    if (a[0] == '-' && nb_decimals(b, OPS) != 0) {
        my_putstr("ERROR\n");
        exit(84);
    } 
    if (nb_decimals(b, OPS) == 0)
        return my_pow(a, b, BASE, OPS);
    char *ln_a =  my_ln(a);
    char *b_ln_a = infin_mul(b, ln_a, BASE, OPS);
    char *result = my_exp(b_ln_a, BASE, OPS);

    free(ln_a);
    free(b_ln_a);
    return result;                                                   
}